name: Deploy VM Key Vault Extension

on:
  push:
    branches:
      - main # Trigger on pushes to the main branch
    paths:
      - 'AzureKeyVault/bicep/**' # Only trigger if files in the bicep directory change
  workflow_dispatch: # Allow manual triggering from GitHub UI

env:
  # Define environment variables for common values
  RESOURCE_GROUP_NAME: Samuel_KeyVault_RG
  VM_NAME: SamuelKV
  # Corrected paths to be relative to the repository root after checkout
  BICEP_FILE_PATH: bicep/vm-keyvault-extension.bicep
  PARAMETERS_FILE_PATH: bicep/vm-keyvault-extension.parameters.json

jobs:
  deploy:
    runs-on: ubuntu-22.04 # Use the latest Ubuntu runner

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4 # Action to check out your repository code

      - name: Azure Login
        uses: azure/login@v2 # Action to log into Azure using a Service Principal
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }} # GitHub Secret containing your Service Principal JSON
      
      - name: Wait before deployment
        run: sleep 10 # Wait for 10 seconds
        
      - name: Deploy VM Key Vault Extension via Azure CLI
        run: |
          # Use Azure CLI directly to perform the deployment
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP_NAME }} \
            --template-file ${{ env.BICEP_FILE_PATH }} \
            --parameters ${{ env.PARAMETERS_FILE_PATH }} \
            --name deploy-kv-ext-${{ github.run_id }} \
            --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID || fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }} \
            --debug # <--- CHANGE from --verbose to --debug
            # No need for --fail-on-stderr here, as the 'run' step will fail on non-zero exit codes.
        shell: bash # Explicitly define the shell for clarity and consistency
